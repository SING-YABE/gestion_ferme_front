<div>
  <div class="odyssey-shadow-low bg-white border-round">
    <div class="px-4 py-2 flex gap-3 align-items-center">
      <div class="flex-1">
        <h5 class="m-0">Gestion des rôles et permissions</h5>
      </div>
      <div fxFlex="300px">
        <input type="search" pInputText class="w-full" placeholder="Rechercher" />
      </div>

      <div>
        <app-role-permission-form (onUpdate)="handleUpdate()"></app-role-permission-form>
      </div>
    </div>

    <div>
      <p-table
        [loading]="loading"
        [lazy]="true"
        [totalRecords]="rolesPage.totalElements"
        (onLazyLoad)="paginate($event)"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 20]"
        [value]="roles || []"
        [paginator]="true">

        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="name">Nom <p-sortIcon field="name"></p-sortIcon></th>
            <th pSortableColumn="code">Code <p-sortIcon field="code"></p-sortIcon></th>
            <th style="text-align: center;">Actions</th> <!-- Colonne Actions -->
          </tr>
        </ng-template>

        <!-- Bouton Supprimer dans la table -->
        <ng-template pTemplate="body" let-role>
          <tr>
            <td>
              <strong>{{ role.name }}</strong>
            </td>
            <td>
              <span>{{ role.code }}</span>
            </td>
            <td>
              <div class="flex gap-2 justify-content-center">
                <!-- Bouton Voir Détails -->
                <button (click)="showRoleDetails(role)"
                        class="p-button-rounded p-button-info"
                        pButton icon="pi pi-eye">
                </button>
                <button
                  pButton
                  class="p-button-warning p-button-rounded"
                  icon="pi pi-pencil"
                  (click)="editRole(role)">
                </button>

                <!-- Bouton Supprimer avec Confirmation -->
                <button
                  pButton
                  class="p-button-danger p-button-rounded"
                  icon="pi pi-trash"
                  (click)="handleDelete(role)">
                </button>

              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="3">Aucun rôle trouvé</td>
          </tr>
        </ng-template>

      </p-table>
    </div>
  </div>

  <!-- Modal pour afficher les permissions -->
  <p-dialog [(visible)]="displayModal" [modal]="true" [closable]="false" [style]="{width: '50vw'}">
    <p-header>
      Permissions du rôle
    </p-header>
    <div *ngIf="selectedRole">
      <h6>{{ selectedRole.name }} - {{ selectedRole.code }}</h6>
      <ul>
        <li *ngFor="let permission of selectedRole.permissions">
          {{ permission.name }}
        </li>
      </ul>
    </div>
    <p-footer>
      <button pButton label="Fermer" icon="pi pi-times" (click)="displayModal = false"></button>
    </p-footer>
  </p-dialog>

  <p-dialog [(visible)]="editModal" [modal]="true" [closable]="false" [style]="{width: '600px'}">
    <p-header>
      Modifier le Rôle
    </p-header>

    <div class="pt-2">
      <div class="field">
        <label for="roleName">Nom du rôle</label>
        <input id="roleName" [(ngModel)]="editedRole.name" pInputText placeholder="Nom du rôle">
      </div>

      <div class="field">
        <label for="roleCode">Code du rôle</label>
        <input id="roleCode" [(ngModel)]="editedRole.code" pInputText placeholder="Code unique du rôle">
      </div>

      <div class="field">
        <label for="permissions">Permissions</label>
        <p-multiSelect
          appendTo="body"
          id="permissions"
          [options]="permissionsList"
          [(ngModel)]="editedRole.permissionsId"
          optionLabel="name"
          optionValue="code"
          placeholder="Sélectionner des permissions">
        </p-multiSelect>
      </div>

    </div>

    <ng-template pTemplate="footer">
      <button (click)="editModal = false" pButton class="p-button-danger mr-2 p-button-outlined">Annuler</button>
      <button [loading]="processing" (click)="updateRole()" pButton>Enregistrer</button>
    </ng-template>

  </p-dialog>

  <!-- Composant de confirmation de suppression -->
  <p-confirmDialog></p-confirmDialog>

</div>

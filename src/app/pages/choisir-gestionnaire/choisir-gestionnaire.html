<!-- src/app/pages/choisir-gestionnaire/choisir-gestionnaire.component.html -->
<div class="card">
  <p-toast></p-toast>

  <!-- En-tête -->
  <div class="flex justify-content-between align-items-center mb-4">
    <h2>Choisir Gestionnaire</h2>
    <div class="flex align-items-center gap-3">
      
      <p-button 
        icon="pi pi-refresh" 
        label="Actualiser" 
        (click)="loadAssignationsSansGestionnaire()"
        [disabled]="loading">
      </p-button>
    </div>
  </div>

  <!-- Indicateur de chargement -->
  <div *ngIf="loading" class="flex justify-content-center p-4">
    <div class="flex flex-column align-items-center gap-3">
      <i class="pi pi-spinner pi-spin" style="font-size: 2rem"></i>
      <span class="text-color-secondary">Chargement des assignations...</span>
    </div>
  </div>

  <!-- Tableau des assignations sans gestionnaire -->
  <p-table 
    *ngIf="!loading"
    [value]="assignationsSansGestionnaire" 
    [paginator]="true" 
    [rows]="10"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} assignations"
    [rowsPerPageOptions]="[10,25,50]">
    
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 80px">ID</th>
        <th>Demande</th>
        <th>Categorie</th>
        <th>Beneficiaire</th>
        <th>Statut</th>
        <th>Date creation</th>
        <th style="width: 150px">Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-assignation>
      <tr>
        <td><strong>#{{ assignation.idAssignation }}</strong></td>
        <td>Demande #{{ assignation.demandeId }}</td>
        <td>{{ assignation.categorieNom || 'Non specifiee' }}</td>
        <td>
          <div class="flex align-items-center gap-2">
            <i class="pi pi-user"></i>
            <!-- MODIFICATION ICI : Afficher le nom complet -->
            <span>{{ assignation.beneficiairePrenom }} {{ assignation.beneficiaireNom }}</span>
          </div>
        </td>
        <td>
          <p-tag value="En attente" severity="warning"></p-tag>
        </td>
        <td>{{ assignation.dateCreation | date:'dd/MM/yyyy' }}</td>
        <td>
          <div class="flex gap-2">
            <!-- Bouton Choisir Gestionnaire -->
            <p-button 
              icon="pi pi-user-plus" 
              label="Choisir" 
              severity="info"
              (click)="openModal(assignation)"
              pTooltip="Choisir un gestionnaire pour cette assignation"
              tooltipPosition="top">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center p-4">
          <i class="pi pi-check-circle" style="font-size: 2rem; color: var(--green-500)"></i>
          <p class="mt-2">Aucune assignation en attente</p>
          <p class="text-sm text-color-secondary">
            Toutes les assignations ont un gestionnaire assigne.
          </p>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Modal de Selection du Gestionnaire -->
  <p-dialog 
    [(visible)]="displayModal" 
    [style]="{ width: '500px' }"
    header="Choisir un gestionnaire"
    [modal]="true"
    [draggable]="false"
    [resizable]="false">
    
    <div *ngIf="assignationEnCours" class="p-fluid">
      <!-- Informations sur l'assignation -->
      <div class="mb-4 p-3 border-round surface-ground">
        <h4 class="mt-0 mb-2">Details de l'assignation</h4>
        <div class="grid text-sm">
          <div class="col-6">
            <strong>ID Assignation:</strong> #{{ assignationEnCours.idAssignation }}
          </div>
          <div class="col-6">
            <strong>Demande:</strong> #{{ assignationEnCours.demandeId }}
          </div>
          <div class="col-6">
            <strong>Categorie:</strong> {{ assignationEnCours.categorieNom }}
          </div>
          <div class="col-6">
            <!-- MODIFICATION ICI : Afficher le nom complet du bénéficiaire -->
            <strong>Beneficiaire:</strong> {{ assignationEnCours.beneficiairePrenom }} {{ assignationEnCours.beneficiaireNom }}
          </div>
        </div>
      </div>

      <!-- Selection du gestionnaire -->
      <div class="field">
        <label for="gestionnaire" class="block font-medium mb-2">Gestionnaire *</label>
        <p-dropdown
          id="gestionnaire"
          [(ngModel)]="gestionnaireSelectionne"
          [options]="gestionnaires"
          optionLabel="nom"
          optionValue="idUtilisateur"
          placeholder="Selectionnez un gestionnaire"
          [showClear]="true"
          class="w-full">
          <ng-template let-gestionnaire pTemplate="item">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-user"></i>
              <span>{{ gestionnaire.prenom }} {{ gestionnaire.nom }}</span>
              <p-tag value="Gestionnaire" severity="info" styleClass="text-xs"></p-tag>
            </div>
          </ng-template>
        </p-dropdown>
        <small class="text-color-secondary">
          Choisissez un utilisateur avec le role Gestionnaire pour traiter cette assignation
        </small>
      </div>

      <div class="p-3 border-round surface-blue-100 mt-3">
        <div class="flex align-items-center gap-2 text-blue-600">
          <i class="pi pi-info-circle"></i>
          <strong>Information</strong>
        </div>
        <p class="text-sm text-blue-600 mt-1 mb-0">
          Le gestionnaire selectionne sera responsable de choisir un equipement disponible et de confirmer l'assignation.
        </p>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button 
        label="Annuler" 
        icon="pi pi-times" 
        (click)="displayModal = false" 
        severity="secondary">
      </p-button>
      <p-button 
        label="Assigner le gestionnaire" 
        icon="pi pi-check" 
        (click)="choisirGestionnaire()"
        [disabled]="!gestionnaireSelectionne">
      </p-button>
    </ng-template>
  </p-dialog>
</div>
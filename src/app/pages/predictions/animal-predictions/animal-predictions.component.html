<div class="animal-predictions-container">

  <!-- Message si modèle non entraîné -->
  <p-message 
    *ngIf="!modelTrained" 
    severity="warn" 
    text="Le modèle n'est pas encore entraîné. Entraînez-le pour commencer les prédictions."
    styleClass="mb-4"
  ></p-message>

  <!-- Bouton entraînement -->
  <div class="training-section" *ngIf="!modelTrained">
    <p-card>
      <div class="training-content">
        <div class="training-info">
          <i class="pi pi-info-circle"></i>
          <div>
            <h3>Entraînement requis</h3>
            <p>Le modèle doit être entraîné avec minimum 50 prix pour faire des prédictions.</p>
          </div>
        </div>
        <p-button 
          label="Entraîner le modèle"
          icon="pi pi-cog"
          [loading]="trainingModel"
          (onClick)="trainModel()"
          severity="success"
          [raised]="true"
        ></p-button>
      </div>
    </p-card>
  </div>

  <!-- Formulaires de prédiction -->
  <div class="predictions-grid" *ngIf="modelTrained">

    <!-- CARD 1 : Prédiction unique -->
    <p-card styleClass="prediction-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-calendar-plus"></i>
          <span>Prédiction à une date</span>
        </div>
      </ng-template>

      <div class="form-content">
        <!-- Sélection animal -->
        <div class="form-field">
          <label>Animal</label>
          <p-dropdown 
            [(ngModel)]="selectedAnimal"
            [options]="animalTypes"
            optionLabel="label"
            optionValue="value"
            placeholder="Sélectionnez un animal"
            [style]="{'width': '100%'}"
            (onChange)="reset()"
          ></p-dropdown>
        </div>

        <!-- Sélection date -->
        <div class="form-field">
          <label>Date de prédiction</label>
          <p-calendar 
            [(ngModel)]="predictionDate"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            [style]="{'width': '100%'}"
            placeholder="Sélectionnez une date"
            [minDate]="minDate"
          ></p-calendar>
        </div>

        <!-- Bouton prédire -->
        <p-button 
          label="Prédire"
          icon="pi pi-chart-line"
          [loading]="loadingSinglePrediction"
          (onClick)="predictSingle()"
          [style]="{'width': '100%'}"
          severity="success"
        ></p-button>

        <!-- Résultat -->
        <div class="prediction-result" *ngIf="singlePrediction">
          <p-divider></p-divider>
          
          <div class="result-main">
            <span class="result-label">Prix prédit</span>
            <span class="result-value">{{ formatNumber(singlePrediction.prix_predit) }} <small>FCFA</small></span>
          </div>

          <div class="result-details">
            <div class="result-item">
              <span class="result-item-label">
                <i class="pi pi-arrow-down"></i>
                Minimum
              </span>
              <span class="result-item-value">{{ formatNumber(singlePrediction.intervalle_min) }} F</span>
            </div>
            <div class="result-item">
              <span class="result-item-label">
                <i class="pi pi-arrow-up"></i>
                Maximum
              </span>
              <span class="result-item-value">{{ formatNumber(singlePrediction.intervalle_max) }} F</span>
            </div>
          </div>

          <div class="result-footer">
            <p-tag 
              [value]="singlePrediction.confiance" 
              [severity]="getConfidenceSeverity(singlePrediction.confiance)"
              [rounded]="true"
            ></p-tag>
          </div>
        </div>
      </div>
    </p-card>

    <!-- CARD 2 : Prédictions futures -->
    <p-card styleClass="prediction-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-chart-line"></i>
          <span>Prédictions futures</span>
        </div>
      </ng-template>

      <div class="form-content">
        <!-- Sélection animal -->
        <div class="form-field">
          <label>Animal</label>
          <p-dropdown 
            [(ngModel)]="selectedAnimal"
            [options]="animalTypes"
            optionLabel="label"
            optionValue="value"
            placeholder="Sélectionnez un animal"
            [style]="{'width': '100%'}"
            (onChange)="reset()"
          ></p-dropdown>
        </div>

        <!-- Nombre de mois -->
        <div class="form-field">
          <label>Nombre de mois</label>
          <p-inputNumber 
            [(ngModel)]="futureMonths"
            [min]="1"
            [max]="12"
            [showButtons]="true"
            buttonLayout="horizontal"
            incrementButtonIcon="pi pi-plus"
            decrementButtonIcon="pi pi-minus"
            [style]="{'width': '100%'}"
          ></p-inputNumber>
        </div>

        <!-- Bouton prédire -->
        <p-button 
          label="Générer prédictions"
          icon="pi pi-forward"
          [loading]="loadingFuturePredictions"
          (onClick)="predictFuture()"
          [style]="{'width': '100%'}"
          severity="success"
        ></p-button>
      </div>
    </p-card>

  </div>

  <!-- Graphique -->
  <div class="chart-section" *ngIf="chartData && modelTrained">
    <p-card>
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-chart-bar"></i>
          <span>Évolution prévue - {{ selectedAnimal | titlecase }}</span>
        </div>
      </ng-template>
      
      <div class="chart-container">
        <p-chart 
          type="line" 
          [data]="chartData" 
          [options]="chartOptions"
          [style]="{'height': '400px'}"
        ></p-chart>
      </div>
    </p-card>
  </div>

  <!-- Tableau des résultats -->
  <div class="table-section" *ngIf="futurePredictions.length > 0 && modelTrained">
    <p-card>
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-table"></i>
          <span>Détail des prédictions</span>
        </div>
      </ng-template>

      <p-table 
        [value]="futurePredictions" 
        [tableStyle]="{'min-width': '50rem'}"
        styleClass="p-datatable-sm"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Date</th>
            <th>Animal</th>
            <th class="text-right">Prix prédit</th>
            <th class="text-right">Intervalle min</th>
            <th class="text-right">Intervalle max</th>
            <th class="text-center">Confiance</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-pred>
          <tr>
            <td>{{ formatDateFromAPI(pred.date) }}</td>
            <td>
              <span class="animal-badge">{{ pred.animal_type | titlecase }}</span>
            </td>
            <td class="text-right">
              <strong class="price-value">{{ formatNumber(pred.prix_predit) }} F</strong>
            </td>
            <td class="text-right text-muted">{{ formatNumber(pred.intervalle_min) }} F</td>
            <td class="text-right text-muted">{{ formatNumber(pred.intervalle_max) }} F</td>
            <td class="text-center">
              <p-tag 
                [value]="pred.confiance" 
                [severity]="getConfidenceSeverity(pred.confiance)"
                [rounded]="true"
              ></p-tag>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </div>

  <!-- Spinner global -->
  <div class="loading-overlay" *ngIf="trainingModel">
    <p-progressSpinner></p-progressSpinner>
    <p>Entraînement en cours...</p>
  </div>

</div>
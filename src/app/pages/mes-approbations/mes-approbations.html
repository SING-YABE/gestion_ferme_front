<!-- src/app/pages/mes-approbations/mes-approbations.component.html -->
<div class="card">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- En-tête -->
  <div class="flex justify-content-between align-items-center mb-4">
    <h2>Mes Approbations</h2>
    <div class="flex align-items-center gap-3">
      <div *ngIf="utilisateurConnecte" class="flex align-items-center gap-2 text-color-secondary">
        <i class="pi pi-user"></i>
        <span class="text-sm">{{ utilisateurConnecte.prenom }} {{ utilisateurConnecte.nom }}</span>
      </div>
      <p-button 
        icon="pi pi-refresh" 
        label="Actualiser" 
        (click)="loadEtapesEnAttente()"
        [disabled]="loading">
      </p-button>
    </div>
  </div>

  <!-- Indicateur de chargement -->
  <div *ngIf="loading" class="flex justify-content-center p-4">
    <div class="flex flex-column align-items-center gap-3">
      <i class="pi pi-spinner pi-spin" style="font-size: 2rem"></i>
      <span class="text-color-secondary">Chargement de vos approbations...</span>
    </div>
  </div>

  <!-- Tableau des approbations -->
  <p-table 
    *ngIf="!loading"
    [value]="etapesEnAttente" 
    [paginator]="true" 
    [rows]="10"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} approbations"
    [rowsPerPageOptions]="[10,25,50]">
    
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 80px">ID Étape</th>
        <th>Ordre</th>
        <th>ID Demande</th>
        <th>Catégorie</th>
        <th>Bénéficiaire</th>
        <th>Statut Demande</th>
        <th>Progression</th>
        <th style="width: 150px">Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-etape>
      <tr>
        <td><strong>#{{ etape.idEtapeValidation }}</strong></td>
        <td>
          <p-tag [value]="'Étape ' + etape.ordre" severity="warning"></p-tag>
        </td>
        <td>
          <strong>#{{ etape.demandeId }}</strong>
        </td>
        <td>
          {{ getDemandePourEtape(etape)?.categorieNom || 'Chargement...' }}
        </td>
        <td>
          <div class="flex align-items-center gap-2">
            <i class="pi pi-user"></i>
            <span>{{ getDemandePourEtape(etape)?.beneficiaireNom || 'Chargement...' }}</span>
          </div>
        </td>
        <td>
          <p-tag 
            *ngIf="getDemandePourEtape(etape)"
            [value]="getStatutLabel(getDemandePourEtape(etape)!.statut)" 
            [severity]="getStatutBadge(getDemandePourEtape(etape)!.statut)">
          </p-tag>
          <span *ngIf="!getDemandePourEtape(etape)" class="text-color-secondary">-</span>
        </td>
        <td>
          <div *ngIf="getDemandePourEtape(etape) as demande; else sansProgression">
            <div *ngIf="demande.statut !== 'NON_SOUMISE' && demande.statut !== 'REJETEE'; else sansProgression">
              <div class="flex align-items-center gap-2">
                <p-progressBar 
                  [value]="getProgression(demande)" 
                  [showValue]="false"
                  styleClass="w-8rem"
                  [style]="{'height': '8px'}">
                </p-progressBar>
                <small>{{ getProgression(demande) | number:'1.0-0' }}%</small>
              </div>
              <small class="text-color-secondary">
                {{ getEtapesValideesCount(demande) }}/3 étapes
              </small>
            </div>
          </div>
          <ng-template #sansProgression>
            <span class="text-color-secondary">-</span>
          </ng-template>
        </td>
        <td>
          <div class="flex gap-2">
            <!-- Bouton Détails Demande -->
            <p-button 
              *ngIf="getDemandePourEtape(etape)"
              icon="pi pi-eye" 
              severity="info" 
              (click)="openDetailModal(getDemandePourEtape(etape)!)"
              pTooltip="Voir les détails de la demande"
              tooltipPosition="top">
            </p-button>

            <!-- Bouton Valider/Rejeter -->
            <p-button 
              icon="pi pi-check" 
              severity="success" 
              (click)="openValidationModal(etape)"
              pTooltip="Traiter cette approbation"
              tooltipPosition="top">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="text-center p-4">
          <i class="pi pi-check-circle" style="font-size: 2rem; color: var(--green-500)"></i>
          <p class="mt-2">Aucune approbation en attente</p>
          <p class="text-sm text-color-secondary">
            Toutes vos approbations sont à jour. Les nouvelles demandes vous seront assignées automatiquement.
          </p>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Modal de Validation -->
  <p-dialog 
    [(visible)]="displayValidationModal" 
    [style]="{ width: '500px' }"
    [header]="'Valider - Etape ' + (etapeEnCours?.ordre || '')"
    [modal]="true"
    [draggable]="false"
    [resizable]="false">
    
    <div *ngIf="etapeEnCours && demandeEnCours" class="p-fluid">
      <!-- Informations sur la demande -->
      <div class="mb-4 p-3 border-round surface-ground">
        <h4 class="mt-0 mb-2">Details de la demande</h4>
        <div class="grid text-sm">
          <div class="col-6">
            <strong>ID:</strong> #{{ demandeEnCours.idDemande }}
          </div>
          <div class="col-6">
            <strong>Categorie:</strong> {{ demandeEnCours.categorieNom }}
          </div>
          <div class="col-6">
            <strong>Beneficiaire:</strong> {{ demandeEnCours.beneficiaireNom || 'Moi-meme' }}
          </div>
          <div class="col-6">
            <strong>Date:</strong> {{ demandeEnCours.dateCreation | date:'dd/MM/yyyy' }}
          </div>
        </div>
      </div>

      <!-- Sélection de la décision -->
      <div class="field">
        <label class="block font-medium mb-2">Decision *</label>
        <div class="flex gap-3">
          <div class="flex align-items-center">
            <p-radioButton 
              name="decision" 
              value="VALIDE" 
              [(ngModel)]="decision"
              inputId="valider"></p-radioButton>
            <label for="valider" class="ml-2 cursor-pointer text-green-600">
              <i class="pi pi-check mr-1"></i>Valider
            </label>
          </div>
          <div class="flex align-items-center">
            <p-radioButton 
              name="decision" 
              value="REJETEE" 
              [(ngModel)]="decision"
              inputId="rejeter"></p-radioButton>
            <label for="rejeter" class="ml-2 cursor-pointer text-red-600">
              <i class="pi pi-times mr-1"></i>Rejeter
            </label>
          </div>
        </div>
      </div>

      <!-- Commentaire -->
      <div class="field">
        <label for="commentaire" class="block font-medium mb-2">Commentaire (optionnel)</label>
        <textarea 
          id="commentaire"
          pInputTextarea 
          [(ngModel)]="commentaireValidation"
          [rows]="3"
          placeholder="Ajouter un commentaire sur votre decision..."
          class="w-full">
        </textarea>
      </div>

      <!-- Avertissement pour rejet -->
      <div *ngIf="decision === 'REJETEE'" class="p-3 border-round surface-red-100">
        <div class="flex align-items-center gap-2 text-red-600">
          <i class="pi pi-exclamation-triangle"></i>
          <strong>Attention</strong>
        </div>
        <p class="text-sm text-red-600 mt-1 mb-0">
          Le rejet de cette etape entraînera le rejet definitif de la demande.
        </p>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button 
        label="Annuler" 
        icon="pi pi-times" 
        (click)="displayValidationModal = false" 
        severity="secondary">
      </p-button>
      <p-button 
        [label]="decision === 'VALIDE' ? 'Valider' : 'Rejeter'" 
        [icon]="decision === 'VALIDE' ? 'pi pi-check' : 'pi pi-times'" 
        [severity]="decision === 'VALIDE' ? 'success' : 'danger'"
        (click)="soumettreDecision()">
      </p-button>
    </ng-template>
  </p-dialog>

  <!-- Modal Details Demande -->
  <p-dialog 
    [(visible)]="displayDetailModal" 
    [style]="{ width: '700px' }"
    [header]="'Details de la demande #' + (demandeDetail?.idDemande || '')"
    [modal]="true"
    [draggable]="false"
    [resizable]="false">
    
    <div *ngIf="demandeDetail" class="p-fluid">
      <!-- Informations générales -->
      <div class="grid">
        <div class="col-6">
          <div class="field">
            <label class="font-medium">Date de creation</label>
            <p>{{ demandeDetail.dateCreation | date:'dd/MM/yyyy a HH:mm' }}</p>
          </div>
        </div>
        <div class="col-6">
          <div class="field">
            <label class="font-medium">Statut</label>
            <div>
              <p-tag 
                [value]="getStatutLabel(demandeDetail.statut)" 
                [severity]="getStatutBadge(demandeDetail.statut)">
              </p-tag>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="field">
            <label class="font-medium">Categorie</label>
            <p>{{ demandeDetail.categorieNom }}</p>
          </div>
        </div>
        <div class="col-6">
          <div class="field">
            <label class="font-medium">Beneficiaire</label>
            <p>{{ demandeDetail.beneficiaireNom || 'Moi-meme' }}</p>
          </div>
        </div>
      </div>

      <!-- Workflow de validation -->
      <div class="mt-4">
        <h4>Workflow de validation</h4>
        <div *ngIf="demandeDetail.etapesValidation.length > 0; else aucuneEtape" class="mt-3">
          <div class="flex flex-column gap-3">
            <div *ngFor="let etape of demandeDetail.etapesValidation" 
                 class="p-3 border-round surface-ground">
              <div class="flex justify-content-between align-items-center">
                <div class="flex align-items-center gap-3">
                  <i [class]="getEtapeIcon(etape.statut)" 
                     [style]="getEtapeColor(etape.statut)"
                     style="font-size: 1.5rem"></i>
                  <div>
                    <h5 class="mt-0 mb-1">Etape {{ etape.ordre }}</h5>
                    <p class="text-sm mb-1">{{ etape.approbateurNom }}</p>
                    <p-tag 
                      [value]="getStatutValidationLabel(etape.statut)" 
                      [severity]="etape.statut === 'VALIDE' ? 'success' : etape.statut === 'REJETEE' ? 'danger' : 'warning'"
                      styleClass="text-xs">
                    </p-tag>
                  </div>
                </div>
                <div *ngIf="etape.statut === 'EN_ATTENTE'" class="text-orange-500">
                  <i class="pi pi-clock mr-1"></i>
                  <span class="text-sm">En attente</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <ng-template #aucuneEtape>
          <div class="p-3 text-center border-round surface-section">
            <i class="pi pi-info-circle text-color-secondary" style="font-size: 2rem"></i>
            <p class="mt-2 text-color-secondary">Demande non soumise</p>
            <p class="text-sm text-color-secondary">
              Soumettez la demande pour lancer le processus de validation
            </p>
          </div>
        </ng-template>
      </div>
    </div>
  </p-dialog>
</div>
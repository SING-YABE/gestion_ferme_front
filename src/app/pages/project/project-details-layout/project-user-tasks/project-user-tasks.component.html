<div>
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div style="margin-top: -10px; margin-left: -30px; margin-right: -30px"
    class="flex mb-3 gap-3 pl-3 pr-3 pb-2 align-items-center h-8rem bg-primary">
    <div style="margin-top: -15px" class="flex-1 pl-3 d-flex justify-content-between align-items-center">
      <h4>{{ projectId }} > Liste des tâches</h4>
      <button style="
        background-color: rgba(0, 0, 0, 0.47);
        margin-bottom: 20px !important;
        margin-right: 13px;" class="p-button-sm p-button" pButton icon="pi pi-plus" label="Nouvelle Tâche"
        (click)="showNewTaskModal()"></button>

      <!-- <button
        style="
          background-color: rgba(0, 0, 0, 0.47);
          margin-bottom: 20px !important;
          margin-right: 13px;
        "
        class="p-button-sm p-button"
        pButton
        [icon]="showingMyTasks ? 'pi pi-eye-slash' : 'pi pi-eye'"
        (click)="toggleTaskView()"
      >
        {{ showingMyTasks ? "Voir toutes les tâches" : "Voir mes tâches" }}
      </button> -->
    </div>
  </div>

  <div style="margin-top: -75px" class="odyssey-shadow-low border-round">
    <p-table [loading]="loading" [lazy]="true" [rows]="10" [rowsPerPageOptions]="[5, 10, 30, 40]" [value]="taches"
      [paginator]="true">
      <ng-template pTemplate="header">
        <tr class="bg-white">
          <th pSortableColumn="title">
            Libellé <p-sortIcon field="title"></p-sortIcon>
          </th>
          <th pSortableColumn="actionPlan">
            Plan d'action <p-sortIcon field="actionPlan"></p-sortIcon>
          </th>
          <th pSortableColumn="description">
            Date de fin prévue <p-sortIcon field="description"></p-sortIcon>
          </th>
          <th pSortableColumn="Statut">
            Statut <p-sortIcon field="Statut"></p-sortIcon>
          </th>
          <th style="text-align: center">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-tache>
        <tr>
          <td><a>{{ tache.title }}</a></td>
          <td>{{ tache?.actionPlan?.title }}</td>
          <td>{{ tache?.plannedEndDate | date : "dd/MM/YYYY" }}</td>
          <td><p-badge [severity]="tache?.statusSeverity" [value]="tache?.statusLabel"></p-badge></td>
          <td>
            <div class="flex gap-2 justify-content-center">
              <button class="p-button-rounded p-button-info" pButton icon="pi pi-eye" (click)="showTaskDetails(tache)"></button>
              <button class="p-button-warning p-button-rounded" pButton icon="pi pi-pencil" (click)="editTask(tache)"></button>
              <button class="p-button-rounded p-button-danger" pButton icon="pi pi-trash" (click)="deleteTask(tache.id)"> </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td class="text-center px-2 py-3" colspan="5">
            <div>
              <h3 class="font-normal">Aucune tâche trouvée</h3>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-dialog header="Détails de la tâche" [(visible)]="displayTaskModal" [modal]="true" [style]="{ width: '50vw' }"
    [breakpoints]="{ '960px': '75vw', '640px': '90vw' }" [draggable]="false" [resizable]="false">
    <div *ngIf="selectedTask" class="p-3">
      <div class="grid">
        <div class="col-12 mb-3">
          <h2 class="m-0 text-xl font-bold">{{ selectedTask.title }}</h2>
          <span class="task-status mt-2" [ngClass]="selectedTask.statusSeverity">{{ selectedTask.statusLabel }}</span>
        </div>

        <div class="col-12 md:col-6 mb-2">
          <p class="font-bold mb-1">ID de la tâche:</p>
          <p class="m-0">{{ selectedTask.id }}</p>
        </div>

        <div class="col-12 md:col-6 mb-2">
          <p class="font-bold mb-1">Date d'échéance prévue:</p>
          <p class="m-0">
            {{ selectedTask.plannedEndDate | date : "dd/MM/yyyy" }}
          </p>
        </div>

        <div class="col-12 md:col-6 mb-2">
          <p class="font-bold mb-1">Priorité:</p>
          <p class="m-0">
            <span class="task-priority" [ngClass]="'priority-' + selectedTask.priority.toLowerCase()">
              {{
              selectedTask.priority === "LOW"
              ? "Basse"
              : selectedTask.priority === "MEDIUM"
              ? "Moyenne"
              : "Haute"
              }}
            </span>
          </p>
        </div>

        <div class="col-12 md:col-6 mb-2">
          <p class="font-bold mb-1">ID du plan d'action:</p>
          <p class="m-0">{{ selectedTask.actionPlanId }}</p>
        </div>

        <div class="col-12 mb-2">
          <p class="font-bold mb-2">Auteur:</p>
          <div class="ml-3">
            <p class="m-0">
              <span class="font-semibold">Nom complet:</span>
              {{ selectedTask.author.user.firstname }}
              {{ selectedTask.author.user.lastname }}
            </p>
            <p class="m-0">
              <span class="font-semibold">Département:</span>
              {{ selectedTask.author.departmentName }}
            </p>
            <p class="m-0">
              <span class="font-semibold">Email:</span>
              {{ selectedTask.author.user.email }}
            </p>
            <p class="m-0">
              <span class="font-semibold">Rôle:</span>
              {{ selectedTask.author.user.role.name }}
            </p>
          </div>
        </div>

        <div class="col-12 mb-2" *ngIf="selectedTask.executors && selectedTask.executors.length > 0">
          <p class="font-bold mb-2">Exécutants:</p>
          <div class="ml-3" *ngFor="let executor of selectedTask.executors">
            <p class="m-0 font-semibold">
              {{ executor.user?.displayName || "Non spécifié" }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton label="Fermer" icon="pi pi-times" class="p-button-text"
        (click)="displayTaskModal = false"></button>
    </ng-template>
  </p-dialog>


  <p-dialog header="Editer la tâche" [(visible)]="editModal" [modal]="true" [style]="{ width: '50vw' }"
    [breakpoints]="{ '960px': '75vw', '640px': '90vw' }" [draggable]="false" [resizable]="false">

    <form id="taskUpdateForm" [formGroup]="taskUpdateForm!!" (ngSubmit)="handleUpdateTask()">

      <div class="row">
        <div class="field col-6">
          <label for="title">Libéllé</label>
          <input formControlName="title" pInputText="title" id="title" class="w-full" />
        </div>
      </div>
      <div class="row">
        <div class="field col-6">
          <label for="description">Description</label>
          <input formControlName="description" pInputText="description" id="description" class="w-full" />
        </div>
      </div>
      <div class="field col-6">
        <label for="status">Statut</label>
        <p-dropdown formControlName="status" [options]="statusOptions" optionLabel="label" optionValue="value" id="status" class="w-full"></p-dropdown>
      </div>
      <div class="flex mb-2 gap-3">
        <div class="field flex-1">
          <label for="plannedEndDate">Date de fin planifiée</label>
          <p-calendar formControlName="plannedEndDate" appendTo="body" type="text" id="plannedEndDate"></p-calendar>
        </div>
        <div class="field flex-1">
          <label for="actualEndDate">Date de fin actuelle</label>
          <p-calendar formControlName="actualEndDate" appendTo="body" type="text" id="actualEndDate"></p-calendar>
        </div>
      </div>
      <div class="row">
        <p-dropdown
          formControlName="priority"
          [options]="priorityOptions"
          placeholder="Choisir une priorité"
          [ngClass]="{ 'ng-invalid': taskUpdateForm!!.get('priority')?.invalid && taskUpdateForm!!.get('priority')?.touched }"
        />
      </div>



    </form>
    <ng-template pTemplate="footer">
      <button pButton label="Fermer" icon="pi pi-times" class="p-button-text"
        (click)="editModal = false"></button>
        <button [loading]="processing"  type="submit" form="taskUpdateForm" pButton
        label="Enregistrer"></button>
    </ng-template>
  </p-dialog>

  <p-dialog header="Nouvelle Tâche" [(visible)]="displayNewTaskModal" [modal]="true" [style]="{ width: '45vw' }"
    [breakpoints]="{ '960px': '65vw', '640px': '85vw' }" [draggable]="false" [resizable]="false" class="custom-dialog">

    <form id="newTaskForm" [formGroup]="newTaskForm!!" (ngSubmit)="createNewTask()">

      <!-- Libellé -->
      <div class="field">
        <label for="title">Libellé</label>
        <input
          [ngClass]="{ 'p-invalid': newTaskForm!!.controls['title'].invalid && newTaskForm!!.controls['title'].touched }"
          required id="title" formControlName="title" type="text" pInputText>
        <small *ngIf="newTaskForm!!.controls['title'].invalid && newTaskForm!!.controls['title'].touched" class="p-error">
          Ce champ est obligatoire
        </small>
      </div>

      <!-- Description -->
      <div class="field">
        <label for="description">Description</label>
        <input id="description" formControlName="description" type="text" pInputText>
      </div>

      <!-- Date et Priorité -->
      <div class="flex mb-2 gap-3">
        <div class="field flex-1">
          <label for="plannedEndDate">Date de fin prévue</label>
          <p-calendar formControlName="plannedEndDate" appendTo="body" type="text" id="plannedEndDate"></p-calendar>
        </div>

        <div class="field flex-1">
          <label for="priority">Priorité</label>
          <p-dropdown id="priority" formControlName="priority" [options]="priorityOptions" optionLabel="label"
            optionValue="value" class="w-full" placeholder="Sélectionner une priorité" appendTo="body"></p-dropdown>
        </div>
      </div>

      <!-- Exécutants -->

      <div class="field">
        <label for="executors">Exécutants</label>
        <p-multiSelect id="executors" formControlName="executors" [options]="usersOptions"
          optionLabel="member.user.displayName" optionValue="member.user.cuid" placeholder="Sélectionner les exécutants"
          class="w-full" appendTo="body"></p-multiSelect>
      </div>

    </form>

    <!-- Footer -->
    <ng-template pTemplate="footer">
      <button class="mr-2 p-button-outlined p-button-danger" pButton label="Annuler"
        (click)="displayNewTaskModal = false"></button>
      <button [loading]="processing" [disabled]="!newTaskForm!!.valid" type="submit" form="newTaskForm" pButton
        label="Enregistrer"></button>
    </ng-template>

  </p-dialog>


</div>
